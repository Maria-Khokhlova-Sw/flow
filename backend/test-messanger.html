<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–¢–µ—Å—Ç –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–∞ (–±—ç–∫–µ–Ω–¥)</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      max-width: 800px;
      margin: 20px auto;
      padding: 0 16px;
    }
    input, button {
      padding: 8px;
      margin: 4px;
      font-size: 16px;
    }
    #chatBox {
      border: 1px solid #ccc;
      height: 300px;
      overflow-y: auto;
      padding: 10px;
      margin-top: 16px;
      background: #f9f9f9;
      font-family: monospace;
    }
    .msg {
      margin: 6px 0;
      padding: 4px 0;
    }
    .sent { color: #1e40af; }
    .received { color: #059669; }
    .system { color: #7c2d12; font-weight: bold; }
    .error { color: #dc2626; }
  </style>
</head>
<body>
  <h2>üîß –¢–µ—Å—Ç –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–∞ ‚Äî –±—ç–∫–µ–Ω–¥</h2>

  <h3>1. –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è</h3>
  <input id="email" placeholder="Email" value="alice@test.com" />
  <input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª—å" value="123456" />
  <button onclick="register()">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
  <button onclick="login()">–í—Ö–æ–¥</button>
  <p><strong>–¢–æ–∫–µ–Ω:</strong> <span id="tokenDisplay">‚Äî</span></p>

  <h3>2. –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</h3>
  <input id="toUserId" type="number" placeholder="ID –ø–æ–ª—É—á–∞—Ç–µ–ª—è" value="2" />
  <input id="messageText" placeholder="–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è" value="–ü—Ä–∏–≤–µ—Ç!" />
  <button onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å (REST)</button>

  <h3>3. –ß–∞—Ç (WebSocket)</h3>
  <button onclick="connectWs()">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ WebSocket</button>
  <div id="chatBox"></div>

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script>
    let token = null;
    let socket = null;

    // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —á–∞—Ç
    function log(msg, className = '') {
      const el = document.createElement('div');
      el.className = `msg ${className}`;
      el.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      document.getElementById('chatBox').appendChild(el);
      document.getElementById('chatBox').scrollTop = document.getElementById('chatBox').scrollHeight;
    }

    // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∫ API
    async function api(method, url, data = null) {
      const headers = { 'Content-Type': 'application/json' };
      if (token) headers['Authorization'] = `Bearer ${token}`;

      const res = await fetch(`http://localhost:5000${url}`, {
        method,
        headers,
        body: data ? JSON.stringify(data) : null
      });

      if (!res.ok) {
        const err = await res.text();
        throw new Error(err || '–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞');
      }
      return res.json();
    }

    // === –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø ===
    async function register() {
      try {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const data = await api('POST', '/api/auth/register', { email, password });
        token = data.token;
        document.getElementById('tokenDisplay').textContent = token;
        log('‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞', 'system');
      } catch (err) {
        log(`‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ${err.message}`, 'error');
      }
    }

    // === –í–•–û–î ===
    async function login() {
      try {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const data = await api('POST', '/api/auth/login', { email, password });
        token = data.token;
        document.getElementById('tokenDisplay').textContent = token;
        log('‚úÖ –í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω', 'system');
      } catch (err) {
        log(`‚ùå –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ${err.message}`, 'error');
      }
    }

    // === –û–¢–ü–†–ê–í–ö–ê –°–û–û–ë–©–ï–ù–ò–Ø –ß–ï–†–ï–ó REST ===
    async function sendMessage() {
      if (!token) return alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ!');
      try {
        const to = Number(document.getElementById('toUserId').value);
        const content = document.getElementById('messageText').value;
        await api('POST', '/api/messages', { to, content });
        log(`üì§ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: "${content}" ‚Üí –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${to}`, 'sent');
      } catch (err) {
        log(`‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ${err.message}`, 'error');
      }
    }

    // === –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –ö WEBSOCKET ===
    function connectWs() {
      if (socket) return log('‚ö†Ô∏è –£–∂–µ –ø–æ–¥–∫–ª—é—á—ë–Ω', 'error');
      if (!token) return log('‚ùå –°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ!', 'error');

      socket = io('http://localhost:5000', {
        auth: { token }
      });

      socket.on('connect', () => {
        log('üü¢ WebSocket –ø–æ–¥–∫–ª—é—á—ë–Ω', 'system');
      });

      socket.on('new_message', (data) => {
        log(`üì© ${data.from}: "${data.content}"`, 'received');
      });

      socket.on('connect_error', (err) => {
        log(`‚ùå –û—à–∏–±–∫–∞ WebSocket: ${err.message}`, 'error');
      });
    }
  </script>
</body>
</html>